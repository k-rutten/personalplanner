<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Weekplanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Inter', 'Segoe UI', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --system-blue: #007AFF;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --system-teal: #5AC8FA;
            --label-primary: rgba(0, 0, 0, 1);
            --label-secondary: rgba(60, 60, 67, 0.6);
            --label-tertiary: rgba(60, 60, 67, 0.3);
            --system-gray3: #C7C7CC;
            --system-gray5: #E5E5EA;
            --system-gray6: #F2F2F7;
            --card-bg: #FFFFFF;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-4px) scale(0.98); }
        }
        .toast-enter { animation: toast-in 0.25s ease-out forwards; }
        .toast-exit { animation: toast-out 0.2s ease-in forwards; }
    </style>
</head>
<body class="min-h-screen" style="background: var(--system-gray6);">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const DAYS = ['maandag', 'dinsdag', 'woensdag', 'donderdag', 'vrijdag'];
        const DAY_LABELS = { maandag: 'Maandag', dinsdag: 'Dinsdag', woensdag: 'Woensdag', donderdag: 'Donderdag', vrijdag: 'Vrijdag' };
        const DAY_SHORT = { maandag: 'Ma', dinsdag: 'Di', woensdag: 'Wo', donderdag: 'Do', vrijdag: 'Vr' };
        const HOURS_PER_DAY = 8;
        const STORAGE_KEY = 'weekplanner_data';

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        const formatDate = (date) => date.toISOString().split('T')[0];
        const fmt = (n) => Number.isInteger(n) ? n : n.toFixed(1);

        function getDayDate(mondayDate, dayIndex) {
            const d = new Date(mondayDate);
            d.setDate(d.getDate() + dayIndex);
            return d.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
        }

        function createEmptyWeek() {
            const days = {};
            DAYS.forEach(day => { days[day] = { workHours: 0, freeHours: 0 }; });
            return days;
        }

        function loadAllData() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
            catch { return {}; }
        }

        const saveAllData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        function encodeWeekToURL(weekKey, weekData) {
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify({ week: weekKey, days: weekData }))));
            return window.location.origin + window.location.pathname + '?d=' + encoded;
        }

        function decodeWeekFromURL() {
            const encoded = new URLSearchParams(window.location.search).get('d');
            if (!encoded) return null;
            try { return JSON.parse(decodeURIComponent(escape(atob(encoded)))); }
            catch { return null; }
        }

        function isCurrentWeek(mondayDate) {
            return formatDate(mondayDate) === formatDate(getMonday(new Date()));
        }

        // --- iOS-style Stacked Bar Chart ---
        function WeekBarChart({ days }) {
            const maxHours = Math.max(HOURS_PER_DAY, ...DAYS.map(d => {
                const dd = days[d] || { workHours: 0, freeHours: 0 };
                return (parseFloat(dd.workHours) || 0) + (parseFloat(dd.freeHours) || 0);
            }));
            const chartMax = Math.max(maxHours, HOURS_PER_DAY) + 1;
            const targetPct = (HOURS_PER_DAY / chartMax) * 100;
            const barAreaH = 108;

            return (
                <div className="w-full">
                    {/* Chart area */}
                    <div className="relative" style={{ height: `${barAreaH}px` }}>
                        {/* Target line */}
                        <div className="absolute left-0 right-0 flex items-center pointer-events-none"
                            style={{ bottom: `${targetPct}%` }}>
                            <div className="flex-1" style={{ height: '1px', background: 'var(--system-gray3)' }} />
                            <span className="ml-2 flex-shrink-0" style={{ fontSize: '11px', color: 'var(--label-secondary)', fontWeight: 400 }}>{HOURS_PER_DAY}u</span>
                        </div>

                        {/* Bars */}
                        <div className="flex items-end h-full" style={{ gap: '6px', paddingRight: '28px' }}>
                            {DAYS.map(day => {
                                const d = days[day] || { workHours: 0, freeHours: 0 };
                                const work = parseFloat(d.workHours) || 0;
                                const free = parseFloat(d.freeHours) || 0;
                                const total = work + free;
                                const overLimit = total > HOURS_PER_DAY;

                                const workPx = chartMax > 0 ? (work / chartMax) * barAreaH : 0;
                                const freePx = chartMax > 0 ? (free / chartMax) * barAreaH : 0;
                                const totalPx = workPx + freePx;

                                if (total === 0) return (
                                    <div key={day} className="flex-1" />
                                );

                                return (
                                    <div key={day} className="flex-1 flex items-end">
                                        {overLimit ? (
                                            <div className="w-full" style={{
                                                height: `${Math.max(totalPx, 4)}px`,
                                                background: 'var(--system-red)',
                                                borderRadius: '4px',
                                                transition: 'height 0.5s cubic-bezier(0.4, 0, 0.2, 1)'
                                            }} />
                                        ) : (
                                            <div className="w-full flex flex-col-reverse" style={{
                                                height: `${Math.max(totalPx, 4)}px`,
                                                borderRadius: '4px',
                                                overflow: 'hidden',
                                                transition: 'height 0.5s cubic-bezier(0.4, 0, 0.2, 1)'
                                            }}>
                                                {/* Work (bottom) */}
                                                <div style={{
                                                    height: work > 0 ? `${(work / total) * 100}%` : '0',
                                                    background: 'var(--system-blue)',
                                                    minHeight: work > 0 ? '2px' : '0'
                                                }} />
                                                {/* Free (top) */}
                                                <div style={{
                                                    height: free > 0 ? `${(free / total) * 100}%` : '0',
                                                    background: 'var(--system-teal)',
                                                    minHeight: free > 0 ? '2px' : '0'
                                                }} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Day labels */}
                    <div className="flex" style={{ paddingRight: '28px', marginTop: '6px' }}>
                        {DAYS.map(day => (
                            <div key={day} className="flex-1 text-center" style={{ fontSize: '11px', fontWeight: 400, color: 'var(--label-secondary)' }}>
                                {DAY_SHORT[day]}
                            </div>
                        ))}
                    </div>

                    {/* Legend */}
                    <div className="flex items-center justify-center gap-4" style={{ marginTop: '12px' }}>
                        <div className="flex items-center gap-1.5">
                            <div className="rounded-full" style={{ width: '8px', height: '8px', background: 'var(--system-blue)' }} />
                            <span style={{ fontSize: '11px', color: 'var(--label-secondary)' }}>Werk</span>
                        </div>
                        <div className="flex items-center gap-1.5">
                            <div className="rounded-full" style={{ width: '8px', height: '8px', background: 'var(--system-teal)' }} />
                            <span style={{ fontSize: '11px', color: 'var(--label-secondary)' }}>Vrij</span>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Toast ---
        function Toast({ message, visible }) {
            const [show, setShow] = useState(false);
            const [exiting, setExiting] = useState(false);

            useEffect(() => {
                if (visible) {
                    setShow(true);
                    setExiting(false);
                } else if (show) {
                    setExiting(true);
                    const t = setTimeout(() => { setShow(false); setExiting(false); }, 200);
                    return () => clearTimeout(t);
                }
            }, [visible]);

            if (!show) return null;
            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-50">
                    <div className={`px-5 py-2.5 text-white text-sm font-medium rounded-full shadow-lg ${exiting ? 'toast-exit' : 'toast-enter'}`}
                        style={{ background: 'rgba(0,0,0,0.8)' }}>
                        {message}
                    </div>
                </div>
            );
        }

        // --- Week Summary ---
        function WeekSummary({ days }) {
            let totalWork = 0, totalFree = 0, approvedDays = 0;

            DAYS.forEach(day => {
                const d = days[day] || { workHours: 0, freeHours: 0 };
                const work = parseFloat(d.workHours) || 0;
                const free = parseFloat(d.freeHours) || 0;
                totalWork += work;
                totalFree += free;
                if (work + free >= HOURS_PER_DAY) approvedDays++;
            });

            const totalHours = totalWork + totalFree;
            const weekTarget = HOURS_PER_DAY * 5;
            const pct = weekTarget > 0 ? Math.round((totalHours / weekTarget) * 100) : 0;
            const isEmpty = totalHours === 0;
            const overLimit = totalHours > weekTarget;

            const heroColor = overLimit ? 'var(--system-red)' : pct >= 100 ? 'var(--system-green)' : 'var(--label-primary)';

            return (
                <div className="rounded-2xl shadow-sm" style={{ background: 'var(--card-bg)', padding: '20px' }}>
                    {/* Hero stat */}
                    <div className="flex items-baseline gap-2" style={{ marginBottom: '20px' }}>
                        <span className="text-3xl font-bold tracking-tight" style={{ color: heroColor }}>
                            {fmt(totalHours)}
                        </span>
                        <span style={{ fontSize: '15px', color: 'var(--label-secondary)' }}>/ {weekTarget} uur</span>
                        <span className="ml-auto font-semibold tabular-nums" style={{ fontSize: '15px', color: overLimit ? 'var(--system-red)' : pct >= 100 ? 'var(--system-green)' : 'var(--label-secondary)' }}>
                            {pct}%
                        </span>
                    </div>

                    {/* Bar chart */}
                    {isEmpty ? (
                        <div className="flex items-center justify-center" style={{ padding: '32px 0' }}>
                            <p style={{ fontSize: '15px', color: 'var(--label-tertiary)' }}>Vul je uren in om je voortgang te zien</p>
                        </div>
                    ) : (
                        <WeekBarChart days={days} />
                    )}

                    {/* Stats row */}
                    <div className="flex items-center justify-between" style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px solid var(--system-gray5)' }}>
                        <div className="flex" style={{ gap: '20px' }}>
                            <div>
                                <span className="font-semibold" style={{ fontSize: '15px', color: 'var(--label-primary)' }}>{fmt(totalWork)}</span>
                                <span style={{ fontSize: '13px', color: 'var(--label-secondary)', marginLeft: '4px' }}>werk</span>
                            </div>
                            <div>
                                <span className="font-semibold" style={{ fontSize: '15px', color: 'var(--label-primary)' }}>{fmt(totalFree)}</span>
                                <span style={{ fontSize: '13px', color: 'var(--label-secondary)', marginLeft: '4px' }}>vrij</span>
                            </div>
                        </div>
                        <span className="inline-flex items-center rounded-full" style={{ gap: '6px', fontSize: '13px', fontWeight: 500, color: 'var(--label-secondary)', background: 'var(--system-gray6)', padding: '3px 10px' }}>
                            <span className="rounded-full" style={{ width: '6px', height: '6px', background: approvedDays >= 5 ? 'var(--system-green)' : 'var(--system-gray3)' }} />
                            {approvedDays}/5 dagen
                        </span>
                    </div>
                </div>
            );
        }

        // --- Inline Hours Input ---
        function HoursInput({ value, onChange, max, label }) {
            const [focused, setFocused] = useState(false);
            const [localValue, setLocalValue] = useState('');

            useEffect(() => {
                if (!focused) setLocalValue(value ? String(value) : '');
            }, [value, focused]);

            const handleChange = (e) => {
                const raw = e.target.value;
                setLocalValue(raw);
                const parsed = parseFloat(raw);
                onChange(isNaN(parsed) ? 0 : Math.min(parsed, max));
            };

            const handleBlur = () => {
                setFocused(false);
                if (localValue === '' || localValue === '-') {
                    onChange(0);
                    setLocalValue('');
                }
            };

            return (
                <div className="flex items-center" style={{ height: '44px', padding: '0 16px' }}>
                    <span style={{ fontSize: '15px', color: 'var(--label-primary)', fontWeight: 400 }}>{label}</span>
                    <input
                        type="number"
                        value={focused ? localValue : (value || '')}
                        onChange={handleChange}
                        onFocus={(e) => { setFocused(true); setLocalValue(value ? String(value) : ''); e.target.select(); }}
                        onBlur={handleBlur}
                        placeholder="0"
                        pattern="[0-9]*"
                        inputMode="numeric"
                        min="0" max={max} step="0.5"
                        className="ml-auto text-right focus:outline-none"
                        style={{
                            width: '64px',
                            fontSize: '15px',
                            fontWeight: 600,
                            color: 'var(--system-blue)',
                            background: 'transparent',
                            border: 'none',
                            padding: 0
                        }}
                    />
                </div>
            );
        }

        // --- Day Card (iOS grouped rows) ---
        function DayCard({ day, dayIndex, mondayDate, data, onChange, isToday }) {
            const workHours = parseFloat(data.workHours) || 0;
            const freeHours = parseFloat(data.freeHours) || 0;
            const totalDay = workHours + freeHours;
            const approved = totalDay >= HOURS_PER_DAY;
            const overLimit = totalDay > HOURS_PER_DAY;

            const setWork = (val) => onChange(day, { ...data, workHours: val });
            const setFree = (val) => onChange(day, { ...data, freeHours: val });

            const dotColor = overLimit ? 'var(--system-red)' : approved ? 'var(--system-green)' : 'var(--system-gray3)';
            const totalColor = overLimit ? 'var(--system-red)' : approved ? 'var(--system-green)' : 'var(--label-tertiary)';
            const cardBg = isToday ? 'rgba(0, 122, 255, 0.03)' : 'var(--card-bg)';

            return (
                <div className="rounded-2xl shadow-sm overflow-hidden sm:flex-1 transition-all duration-200 hover:shadow-md"
                    style={{ background: cardBg }}>
                    {/* Header row */}
                    <div className="flex items-center" style={{ height: '44px', padding: '0 16px' }}>
                        <span className="font-semibold" style={{ fontSize: '15px', color: 'var(--label-primary)' }}>{DAY_LABELS[day]}</span>
                        <span style={{ fontSize: '13px', color: 'var(--label-secondary)', marginLeft: '6px' }}>{getDayDate(mondayDate, dayIndex)}</span>
                        <div className="ml-auto flex items-center" style={{ gap: '8px' }}>
                            <span className="font-semibold tabular-nums" style={{ fontSize: '13px', color: totalColor }}>
                                {fmt(totalDay)}/{HOURS_PER_DAY}u
                            </span>
                            <span className="rounded-full flex-shrink-0 transition-colors duration-300"
                                style={{ width: '8px', height: '8px', background: dotColor }} />
                        </div>
                    </div>

                    {/* Separator */}
                    <div style={{ height: '1px', background: 'var(--system-gray5)', marginLeft: '16px' }} />

                    {/* Work input row */}
                    <HoursInput value={workHours} onChange={setWork} max={24} label="Werk" />

                    {/* Separator */}
                    <div style={{ height: '1px', background: 'var(--system-gray5)', marginLeft: '16px' }} />

                    {/* Free input row */}
                    <HoursInput value={freeHours} onChange={setFree} max={8} label="Vrij" />
                </div>
            );
        }

        // --- Segmented Control ---
        function SegmentedControl({ onPrev, onToday, onNext, isCurrent }) {
            return (
                <div className="inline-flex rounded-xl p-1" style={{ background: 'rgba(0,0,0,0.06)', gap: '2px' }}>
                    <button onClick={onPrev}
                        className="flex items-center justify-center rounded-lg active:scale-95 transition-all"
                        style={{ width: '44px', height: '44px', fontSize: '15px', color: 'var(--label-secondary)' }}>
                        &larr;
                    </button>
                    <button onClick={onToday}
                        className={`rounded-lg active:scale-95 transition-all ${isCurrent ? 'shadow-sm' : ''}`}
                        style={{
                            padding: '0 20px', height: '44px', fontSize: '15px', fontWeight: 500,
                            color: isCurrent ? 'var(--label-primary)' : 'var(--label-secondary)',
                            background: isCurrent ? 'var(--card-bg)' : 'transparent'
                        }}>
                        Vandaag
                    </button>
                    <button onClick={onNext}
                        className="flex items-center justify-center rounded-lg active:scale-95 transition-all"
                        style={{ width: '44px', height: '44px', fontSize: '15px', color: 'var(--label-secondary)' }}>
                        &rarr;
                    </button>
                </div>
            );
        }

        // --- App ---
        function App() {
            const [currentMonday, setCurrentMonday] = useState(() => getMonday(new Date()));
            const [allData, setAllData] = useState(() => loadAllData());
            const [toastVisible, setToastVisible] = useState(false);

            const weekKey = formatDate(currentMonday);
            const weekData = allData[weekKey] || createEmptyWeek();
            const isCurrent = isCurrentWeek(currentMonday);

            const todayDate = new Date();
            const todayDayOfWeek = todayDate.getDay();
            const todayIndex = isCurrent && todayDayOfWeek >= 1 && todayDayOfWeek <= 5 ? todayDayOfWeek - 1 : -1;

            useEffect(() => {
                const shared = decodeWeekFromURL();
                if (shared && shared.week && shared.days) {
                    setAllData(prev => ({ ...prev, [shared.week]: shared.days }));
                    setCurrentMonday(new Date(shared.week));
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }, []);

            useEffect(() => { saveAllData(allData); }, [allData]);

            const shareWeek = () => {
                navigator.clipboard.writeText(encodeWeekToURL(weekKey, weekData)).then(() => {
                    setToastVisible(true);
                    setTimeout(() => setToastVisible(false), 1800);
                });
            };

            const handleDayChange = useCallback((day, newDayData) => {
                setAllData(prev => ({
                    ...prev,
                    [weekKey]: { ...(prev[weekKey] || createEmptyWeek()), [day]: newDayData }
                }));
            }, [weekKey]);

            const goWeek = (offset) => {
                const next = new Date(currentMonday);
                next.setDate(next.getDate() + offset * 7);
                setCurrentMonday(next);
            };

            const goToday = () => setCurrentMonday(getMonday(new Date()));

            const weekEnd = new Date(currentMonday);
            weekEnd.setDate(weekEnd.getDate() + 4);
            const weekLabel = `${currentMonday.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long' })} \u2014 ${weekEnd.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            return (
                <div className="max-w-xl mx-auto py-6 pb-12 sm:max-w-7xl sm:py-8" style={{ padding: '24px 16px 48px' }}>
                    <Toast message="Link gekopieerd" visible={toastVisible} />

                    {/* Header */}
                    <div className="flex items-center justify-between" style={{ marginBottom: '4px' }}>
                        <h1 className="text-2xl font-bold tracking-tight" style={{ color: 'var(--label-primary)' }}>Weekplanner</h1>
                        <button onClick={shareWeek}
                            className="flex items-center justify-center rounded-full active:scale-90 transition-all"
                            style={{ width: '44px', height: '44px' }}
                            title="Deel week">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ color: 'var(--label-secondary)' }}>
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" /><polyline points="16 6 12 2 8 6" /><line x1="12" y1="2" x2="12" y2="15" />
                            </svg>
                        </button>
                    </div>

                    <p style={{ fontSize: '13px', color: 'var(--label-secondary)', marginBottom: '16px' }}>{weekLabel}</p>

                    {/* Navigation */}
                    <div className="flex justify-center" style={{ marginBottom: '24px' }}>
                        <SegmentedControl
                            onPrev={() => goWeek(-1)}
                            onToday={goToday}
                            onNext={() => goWeek(1)}
                            isCurrent={isCurrent}
                        />
                    </div>

                    {/* Week summary */}
                    <div style={{ marginBottom: '16px' }}>
                        <WeekSummary days={weekData} />
                    </div>

                    {/* Day cards */}
                    <div className="flex flex-col sm:flex-row" style={{ gap: '10px' }}>
                        {DAYS.map((day, i) => (
                            <DayCard
                                key={day}
                                day={day}
                                dayIndex={i}
                                mondayDate={currentMonday}
                                data={weekData[day] || { workHours: 0, freeHours: 0 }}
                                onChange={handleDayChange}
                                isToday={i === todayIndex}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
