<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Weekplanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Inter', 'Segoe UI', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-4px) scale(0.98); }
        }
        .toast-enter { animation: toast-in 0.25s ease-out forwards; }
        .toast-exit { animation: toast-out 0.2s ease-in forwards; }
    </style>
</head>
<body class="min-h-screen" style="background: #f5f5f7;">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const DAYS = ['maandag', 'dinsdag', 'woensdag', 'donderdag', 'vrijdag'];
        const DAY_LABELS = { maandag: 'Maandag', dinsdag: 'Dinsdag', woensdag: 'Woensdag', donderdag: 'Donderdag', vrijdag: 'Vrijdag' };
        const HOURS_PER_DAY = 8;
        const STORAGE_KEY = 'weekplanner_data';

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        const formatDate = (date) => date.toISOString().split('T')[0];
        const fmt = (n) => Number.isInteger(n) ? n : n.toFixed(1);

        function getDayDate(mondayDate, dayIndex) {
            const d = new Date(mondayDate);
            d.setDate(d.getDate() + dayIndex);
            return d.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
        }

        function createEmptyWeek() {
            const days = {};
            DAYS.forEach(day => { days[day] = { workHours: 0, freeHours: 0 }; });
            return days;
        }

        function loadAllData() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
            catch { return {}; }
        }

        const saveAllData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        function encodeWeekToURL(weekKey, weekData) {
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify({ week: weekKey, days: weekData }))));
            return window.location.origin + window.location.pathname + '?d=' + encoded;
        }

        function decodeWeekFromURL() {
            const encoded = new URLSearchParams(window.location.search).get('d');
            if (!encoded) return null;
            try { return JSON.parse(decodeURIComponent(escape(atob(encoded)))); }
            catch { return null; }
        }

        function isCurrentWeek(mondayDate) {
            return formatDate(mondayDate) === formatDate(getMonday(new Date()));
        }

        // --- iOS-style Bar Chart ---
        function WeekBarChart({ days }) {
            const DAY_SHORT = { maandag: 'Ma', dinsdag: 'Di', woensdag: 'Wo', donderdag: 'Do', vrijdag: 'Vr' };
            const maxHours = Math.max(HOURS_PER_DAY, ...DAYS.map(d => {
                const dd = days[d] || { workHours: 0, freeHours: 0 };
                return (parseFloat(dd.workHours) || 0) + (parseFloat(dd.freeHours) || 0);
            }));
            const chartMax = Math.max(maxHours, HOURS_PER_DAY) + 1;
            const targetPct = (HOURS_PER_DAY / chartMax) * 100;

            return (
                <div className="relative w-full" style={{ height: '120px' }}>
                    {/* Target line */}
                    <div className="absolute left-0 right-0 flex items-center z-10 pointer-events-none"
                        style={{ bottom: `${targetPct}%` }}>
                        <div className="flex-1 border-t border-dashed border-gray-300" />
                        <span className="text-[10px] text-gray-400 font-medium ml-1.5 bg-white px-1">{HOURS_PER_DAY}u</span>
                    </div>

                    {/* Bars */}
                    <div className="flex items-end justify-between h-full gap-2 px-1">
                        {DAYS.map(day => {
                            const d = days[day] || { workHours: 0, freeHours: 0 };
                            const work = parseFloat(d.workHours) || 0;
                            const free = parseFloat(d.freeHours) || 0;
                            const total = work + free;
                            const barPct = chartMax > 0 ? (total / chartMax) * 100 : 0;
                            const overLimit = total > HOURS_PER_DAY;
                            const approved = total >= HOURS_PER_DAY;
                            const barColor = overLimit ? 'bg-red-400' : approved ? 'bg-green-400' : total > 0 ? 'bg-blue-400' : 'bg-gray-100';

                            return (
                                <div key={day} className="flex-1 flex flex-col items-center gap-1.5">
                                    <div className="w-full flex items-end" style={{ height: '96px' }}>
                                        <div
                                            className={`w-full rounded-md transition-all duration-500 ${barColor}`}
                                            style={{ height: `${Math.max(barPct, total > 0 ? 4 : 0)}%`, minHeight: total > 0 ? '4px' : '0' }}
                                        />
                                    </div>
                                    <span className="text-[10px] font-medium text-gray-400">{DAY_SHORT[day]}</span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // --- Toast ---
        function Toast({ message, visible }) {
            const [show, setShow] = useState(false);
            const [exiting, setExiting] = useState(false);

            useEffect(() => {
                if (visible) {
                    setShow(true);
                    setExiting(false);
                } else if (show) {
                    setExiting(true);
                    const t = setTimeout(() => { setShow(false); setExiting(false); }, 200);
                    return () => clearTimeout(t);
                }
            }, [visible]);

            if (!show) return null;
            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-50">
                    <div className={`px-5 py-2.5 bg-gray-900 text-white text-sm font-medium rounded-full shadow-lg ${exiting ? 'toast-exit' : 'toast-enter'}`}>
                        {message}
                    </div>
                </div>
            );
        }

        // --- Week Summary ---
        function WeekSummary({ days }) {
            let totalWork = 0, totalFree = 0, approvedDays = 0;

            DAYS.forEach(day => {
                const d = days[day] || { workHours: 0, freeHours: 0 };
                const work = parseFloat(d.workHours) || 0;
                const free = parseFloat(d.freeHours) || 0;
                totalWork += work;
                totalFree += free;
                if (work + free >= HOURS_PER_DAY) approvedDays++;
            });

            const totalHours = totalWork + totalFree;
            const weekTarget = HOURS_PER_DAY * 5;
            const pct = weekTarget > 0 ? Math.round((totalHours / weekTarget) * 100) : 0;
            const isEmpty = totalHours === 0;
            const overLimit = totalHours > weekTarget;

            return (
                <div className="bg-white rounded-2xl shadow-sm p-5">
                    {/* Hero stat */}
                    <div className="flex items-baseline gap-2 mb-4">
                        <span className={`text-3xl font-bold tracking-tight ${overLimit ? 'text-red-500' : pct >= 100 ? 'text-green-500' : 'text-gray-900'}`}>
                            {fmt(totalHours)}
                        </span>
                        <span className="text-sm text-gray-400">/ {weekTarget} uur</span>
                        <span className={`ml-auto text-sm font-semibold tabular-nums ${overLimit ? 'text-red-500' : pct >= 100 ? 'text-green-500' : 'text-gray-400'}`}>
                            {pct}%
                        </span>
                    </div>

                    {/* Bar chart */}
                    {isEmpty ? (
                        <div className="flex items-center justify-center py-8">
                            <p className="text-sm text-gray-400">Vul je uren in om je voortgang te zien</p>
                        </div>
                    ) : (
                        <WeekBarChart days={days} />
                    )}

                    {/* Stats row */}
                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                        <div className="flex gap-5">
                            <div>
                                <span className="text-sm font-semibold text-gray-900">{fmt(totalWork)}</span>
                                <span className="text-xs text-gray-400 ml-1">werk</span>
                            </div>
                            <div>
                                <span className="text-sm font-semibold text-gray-900">{fmt(totalFree)}</span>
                                <span className="text-xs text-gray-400 ml-1">vrij</span>
                            </div>
                        </div>
                        <span className="inline-flex items-center gap-1.5 text-xs font-medium text-gray-500 bg-gray-100 rounded-full px-2.5 py-0.5">
                            <span className={`w-1.5 h-1.5 rounded-full ${approvedDays >= 5 ? 'bg-green-500' : 'bg-gray-300'}`} />
                            {approvedDays}/5 dagen
                        </span>
                    </div>
                </div>
            );
        }

        // --- Number Input (fix #6: proper zero handling) ---
        function HoursInput({ value, onChange, max }) {
            const [focused, setFocused] = useState(false);
            const [localValue, setLocalValue] = useState('');

            useEffect(() => {
                if (!focused) setLocalValue(value ? String(value) : '');
            }, [value, focused]);

            const handleChange = (e) => {
                const raw = e.target.value;
                setLocalValue(raw);
                const parsed = parseFloat(raw);
                onChange(isNaN(parsed) ? 0 : Math.min(parsed, max));
            };

            const handleBlur = () => {
                setFocused(false);
                if (localValue === '' || localValue === '-') {
                    onChange(0);
                    setLocalValue('');
                }
            };

            return (
                <input
                    type="number"
                    value={focused ? localValue : (value || '')}
                    onChange={handleChange}
                    onFocus={(e) => { setFocused(true); setLocalValue(value ? String(value) : ''); e.target.select(); }}
                    onBlur={handleBlur}
                    placeholder="0"
                    pattern="[0-9]*"
                    inputMode="numeric"
                    min="0" max={max} step="0.5"
                    className="w-full h-12 text-center text-lg font-semibold text-gray-900 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white focus:shadow-sm transition-all"
                />
            );
        }

        // --- Day Card ---
        function DayCard({ day, dayIndex, mondayDate, data, onChange, isToday }) {
            const workHours = parseFloat(data.workHours) || 0;
            const freeHours = parseFloat(data.freeHours) || 0;
            const totalDay = workHours + freeHours;
            const approved = totalDay >= HOURS_PER_DAY;
            const overLimit = totalDay > HOURS_PER_DAY;
            const dayPct = Math.min((totalDay / HOURS_PER_DAY) * 100, 100);

            const setWork = (val) => onChange(day, { ...data, workHours: val });
            const setFree = (val) => onChange(day, { ...data, freeHours: val });

            const accentColor = overLimit ? 'bg-red-400' : approved ? 'bg-green-400' : 'bg-gray-200';
            const textColor = overLimit ? 'text-red-500' : approved ? 'text-green-500' : 'text-gray-300';
            const barColor = overLimit ? 'bg-red-400' : approved ? 'bg-green-400' : dayPct > 0 ? 'bg-blue-400' : '';

            return (
                <div className={`bg-white rounded-2xl shadow-sm overflow-hidden transition-all duration-200 hover:shadow-md sm:flex-1 relative ${isToday ? 'ring-2 ring-blue-500/20' : ''}`}>
                    {/* Status accent â€” inner bar */}
                    {approved && (
                        <div className={`absolute top-0 left-0 w-1 h-full ${accentColor} rounded-l-2xl sm:w-full sm:h-1 sm:rounded-t-2xl sm:rounded-l-none`} />
                    )}

                    {/* Header */}
                    <div className="flex items-center justify-between px-4 py-3 sm:flex-col sm:items-center sm:gap-0.5 sm:pt-4 sm:pb-3">
                        <div className="flex items-center gap-2 sm:flex-col sm:items-center">
                            <div className="flex items-center gap-2">
                                <span className={`w-2 h-2 rounded-full flex-shrink-0 transition-colors duration-300 ${accentColor}`} />
                                <span className="font-semibold text-gray-900">{DAY_LABELS[day]}</span>
                            </div>
                            <span className="text-xs text-gray-400">{getDayDate(mondayDate, dayIndex)}</span>
                        </div>
                        <span className={`text-sm font-semibold tabular-nums transition-colors duration-300 ${textColor}`}>
                            {fmt(totalDay)}/{HOURS_PER_DAY}u
                        </span>
                    </div>

                    {/* Inputs */}
                    <div className="grid grid-cols-2 gap-3 px-4 pb-4 sm:grid-cols-1">
                        <div>
                            <label className="text-[11px] font-medium text-gray-400 uppercase tracking-wider block mb-1.5">Werk</label>
                            <HoursInput value={workHours} onChange={setWork} max={24} />
                        </div>
                        <div>
                            <label className="text-[11px] font-medium text-gray-400 uppercase tracking-wider block mb-1.5">Vrij</label>
                            <HoursInput value={freeHours} onChange={setFree} max={8} />
                        </div>
                    </div>

                    {/* Day progress */}
                    <div className="h-1 bg-gray-100">
                        <div
                            className={`h-full transition-all duration-500 ${barColor}`}
                            style={{ width: `${dayPct}%` }}
                        />
                    </div>
                </div>
            );
        }

        // --- Segmented Control ---
        function SegmentedControl({ onPrev, onToday, onNext, isCurrent }) {
            return (
                <div className="inline-flex bg-gray-200/60 rounded-xl p-1 gap-0.5">
                    <button onClick={onPrev}
                        className="w-11 h-11 flex items-center justify-center text-sm font-medium text-gray-500 rounded-lg active:scale-95 active:bg-white/60 transition-all hover:text-gray-900">
                        &larr;
                    </button>
                    <button onClick={onToday}
                        className={`px-5 h-11 text-sm font-medium rounded-lg active:scale-95 transition-all ${isCurrent ? 'text-gray-900 bg-white shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>
                        Vandaag
                    </button>
                    <button onClick={onNext}
                        className="w-11 h-11 flex items-center justify-center text-sm font-medium text-gray-500 rounded-lg active:scale-95 active:bg-white/60 transition-all hover:text-gray-900">
                        &rarr;
                    </button>
                </div>
            );
        }

        // --- App ---
        function App() {
            const [currentMonday, setCurrentMonday] = useState(() => getMonday(new Date()));
            const [allData, setAllData] = useState(() => loadAllData());
            const [toastVisible, setToastVisible] = useState(false);

            const weekKey = formatDate(currentMonday);
            const weekData = allData[weekKey] || createEmptyWeek();
            const isCurrent = isCurrentWeek(currentMonday);

            // Determine today's day index (0=mon, 4=fri, -1=weekend)
            const todayDate = new Date();
            const todayDayOfWeek = todayDate.getDay();
            const todayIndex = isCurrent && todayDayOfWeek >= 1 && todayDayOfWeek <= 5 ? todayDayOfWeek - 1 : -1;

            useEffect(() => {
                const shared = decodeWeekFromURL();
                if (shared && shared.week && shared.days) {
                    setAllData(prev => ({ ...prev, [shared.week]: shared.days }));
                    setCurrentMonday(new Date(shared.week));
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }, []);

            useEffect(() => { saveAllData(allData); }, [allData]);

            const shareWeek = () => {
                navigator.clipboard.writeText(encodeWeekToURL(weekKey, weekData)).then(() => {
                    setToastVisible(true);
                    setTimeout(() => setToastVisible(false), 1800);
                });
            };

            const handleDayChange = useCallback((day, newDayData) => {
                setAllData(prev => ({
                    ...prev,
                    [weekKey]: { ...(prev[weekKey] || createEmptyWeek()), [day]: newDayData }
                }));
            }, [weekKey]);

            const goWeek = (offset) => {
                const next = new Date(currentMonday);
                next.setDate(next.getDate() + offset * 7);
                setCurrentMonday(next);
            };

            const goToday = () => setCurrentMonday(getMonday(new Date()));

            const weekEnd = new Date(currentMonday);
            weekEnd.setDate(weekEnd.getDate() + 4);
            const weekLabel = `${currentMonday.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long' })} \u2014 ${weekEnd.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            return (
                <div className="max-w-xl mx-auto px-4 py-6 pb-12 sm:max-w-7xl sm:py-8">
                    <Toast message="Link gekopieerd" visible={toastVisible} />

                    {/* Header */}
                    <div className="flex items-center justify-between mb-1">
                        <h1 className="text-2xl font-bold text-gray-900 tracking-tight">Weekplanner</h1>
                        <button onClick={shareWeek}
                            className="w-11 h-11 flex items-center justify-center rounded-full hover:bg-gray-200/60 active:scale-90 transition-all"
                            title="Deel week">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" /><polyline points="16 6 12 2 8 6" /><line x1="12" y1="2" x2="12" y2="15" />
                            </svg>
                        </button>
                    </div>

                    <p className="text-sm text-gray-400 mb-4">{weekLabel}</p>

                    {/* Navigation */}
                    <div className="flex justify-center mb-6">
                        <SegmentedControl
                            onPrev={() => goWeek(-1)}
                            onToday={goToday}
                            onNext={() => goWeek(1)}
                            isCurrent={isCurrent}
                        />
                    </div>

                    {/* Week summary */}
                    <div className="mb-6">
                        <WeekSummary days={weekData} />
                    </div>

                    {/* Day cards */}
                    <div className="flex flex-col gap-3 sm:flex-row sm:gap-3">
                        {DAYS.map((day, i) => (
                            <DayCard
                                key={day}
                                day={day}
                                dayIndex={i}
                                mondayDate={currentMonday}
                                data={weekData[day] || { workHours: 0, freeHours: 0 }}
                                onChange={handleDayChange}
                                isToday={i === todayIndex}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
