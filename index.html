<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Weekplanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Inter', 'Segoe UI', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .ring-progress { transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-4px) scale(0.98); }
        }
        .toast-enter { animation: toast-in 0.25s ease-out forwards; }
        .toast-exit { animation: toast-out 0.2s ease-in forwards; }
    </style>
</head>
<body class="min-h-screen" style="background: #f5f5f7;">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const DAYS = ['maandag', 'dinsdag', 'woensdag', 'donderdag', 'vrijdag'];
        const DAY_LABELS = { maandag: 'Maandag', dinsdag: 'Dinsdag', woensdag: 'Woensdag', donderdag: 'Donderdag', vrijdag: 'Vrijdag' };
        const HOURS_PER_DAY = 8;
        const STORAGE_KEY = 'weekplanner_data';

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        const formatDate = (date) => date.toISOString().split('T')[0];
        const fmt = (n) => Number.isInteger(n) ? n : n.toFixed(1);

        function getDayDate(mondayDate, dayIndex) {
            const d = new Date(mondayDate);
            d.setDate(d.getDate() + dayIndex);
            return d.toLocaleDateString('nl-NL', { day: 'numeric', month: 'short' });
        }

        function createEmptyWeek() {
            const days = {};
            DAYS.forEach(day => { days[day] = { workHours: 0, freeHours: 0 }; });
            return days;
        }

        function loadAllData() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
            catch { return {}; }
        }

        const saveAllData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

        function encodeWeekToURL(weekKey, weekData) {
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify({ week: weekKey, days: weekData }))));
            return window.location.origin + window.location.pathname + '?d=' + encoded;
        }

        function decodeWeekFromURL() {
            const encoded = new URLSearchParams(window.location.search).get('d');
            if (!encoded) return null;
            try { return JSON.parse(decodeURIComponent(escape(atob(encoded)))); }
            catch { return null; }
        }

        function isCurrentWeek(mondayDate) {
            return formatDate(mondayDate) === formatDate(getMonday(new Date()));
        }

        // --- Circular Progress Ring ---
        function ProgressRing({ pct, size = 120, stroke = 8 }) {
            const radius = (size - stroke) / 2;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (Math.min(pct, 100) / 100) * circumference;
            const color = pct >= 100 ? '#22c55e' : '#007AFF';

            return (
                <svg width={size} height={size} className="block">
                    <circle cx={size/2} cy={size/2} r={radius} fill="none"
                        stroke="#f0f0f0" strokeWidth={stroke} />
                    <circle cx={size/2} cy={size/2} r={radius} fill="none"
                        stroke={color} strokeWidth={stroke} strokeLinecap="round"
                        strokeDasharray={circumference} strokeDashoffset={offset}
                        className="ring-progress"
                        style={{ transform: 'rotate(-90deg)', transformOrigin: '50% 50%' }} />
                </svg>
            );
        }

        // --- Toast ---
        function Toast({ message, visible }) {
            const [show, setShow] = useState(false);
            const [exiting, setExiting] = useState(false);

            useEffect(() => {
                if (visible) {
                    setShow(true);
                    setExiting(false);
                } else if (show) {
                    setExiting(true);
                    const t = setTimeout(() => { setShow(false); setExiting(false); }, 200);
                    return () => clearTimeout(t);
                }
            }, [visible]);

            if (!show) return null;
            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-50">
                    <div className={`px-5 py-2.5 bg-gray-900 text-white text-sm font-medium rounded-full shadow-lg ${exiting ? 'toast-exit' : 'toast-enter'}`}>
                        {message}
                    </div>
                </div>
            );
        }

        // --- Week Summary ---
        function WeekSummary({ days }) {
            let totalWork = 0, totalFree = 0, approvedDays = 0;

            DAYS.forEach(day => {
                const d = days[day] || { workHours: 0, freeHours: 0 };
                const work = parseFloat(d.workHours) || 0;
                const free = parseFloat(d.freeHours) || 0;
                totalWork += work;
                totalFree += free;
                if (work + free >= HOURS_PER_DAY) approvedDays++;
            });

            const totalHours = totalWork + totalFree;
            const weekTarget = HOURS_PER_DAY * 5;
            const pct = weekTarget > 0 ? Math.round((totalHours / weekTarget) * 100) : 0;
            const isEmpty = totalHours === 0;

            return (
                <div className="bg-white rounded-2xl shadow-sm p-6">
                    <div className="flex flex-col items-center gap-5 sm:flex-row sm:justify-between">
                        {/* Ring */}
                        <div className="relative">
                            <ProgressRing pct={pct} size={112} stroke={10} />
                            <div className="absolute inset-0 flex flex-col items-center justify-center">
                                <span className={`text-2xl font-bold tracking-tight ${pct >= 100 ? 'text-green-500' : 'text-gray-900'}`}>{pct}%</span>
                            </div>
                        </div>

                        {/* Stats or empty state */}
                        {isEmpty ? (
                            <div className="text-center sm:text-left flex-1">
                                <p className="text-sm text-gray-400">Vul je uren in om je voortgang te zien</p>
                            </div>
                        ) : (
                            <div className="flex gap-8 sm:gap-10">
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-900 tracking-tight">{fmt(totalWork)}</div>
                                    <div className="text-xs text-gray-400 mt-0.5">werkuren</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-900 tracking-tight">{fmt(totalFree)}</div>
                                    <div className="text-xs text-gray-400 mt-0.5">vrij</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-2xl font-bold text-gray-900 tracking-tight">{fmt(totalHours)}</div>
                                    <div className="text-xs text-gray-400 mt-0.5">/ {weekTarget}u</div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Days badge */}
                    <div className="mt-4 flex justify-center sm:justify-start">
                        <span className="inline-flex items-center gap-1.5 text-xs font-medium text-gray-500 bg-gray-100 rounded-full px-3 py-1">
                            <span className={`w-1.5 h-1.5 rounded-full ${approvedDays >= 5 ? 'bg-green-500' : 'bg-gray-300'}`} />
                            {approvedDays} van 5 dagen
                        </span>
                    </div>
                </div>
            );
        }

        // --- Number Input (fix #6: proper zero handling) ---
        function HoursInput({ value, onChange, max }) {
            const [focused, setFocused] = useState(false);
            const [localValue, setLocalValue] = useState('');

            useEffect(() => {
                if (!focused) setLocalValue(value ? String(value) : '');
            }, [value, focused]);

            const handleChange = (e) => {
                const raw = e.target.value;
                setLocalValue(raw);
                const parsed = parseFloat(raw);
                onChange(isNaN(parsed) ? 0 : Math.min(parsed, max));
            };

            const handleBlur = () => {
                setFocused(false);
                if (localValue === '' || localValue === '-') {
                    onChange(0);
                    setLocalValue('');
                }
            };

            return (
                <input
                    type="number"
                    value={focused ? localValue : (value || '')}
                    onChange={handleChange}
                    onFocus={(e) => { setFocused(true); setLocalValue(value ? String(value) : ''); e.target.select(); }}
                    onBlur={handleBlur}
                    placeholder="0"
                    inputMode="decimal"
                    min="0" max={max} step="0.5"
                    className="w-full h-12 text-center text-lg font-semibold text-gray-900 bg-gray-50 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white focus:shadow-sm transition-all"
                />
            );
        }

        // --- Day Card ---
        function DayCard({ day, dayIndex, mondayDate, data, onChange, isToday }) {
            const workHours = parseFloat(data.workHours) || 0;
            const freeHours = parseFloat(data.freeHours) || 0;
            const totalDay = workHours + freeHours;
            const approved = totalDay >= HOURS_PER_DAY;
            const dayPct = Math.min((totalDay / HOURS_PER_DAY) * 100, 100);

            const setWork = (val) => onChange(day, { ...data, workHours: val });
            const setFree = (val) => onChange(day, { ...data, freeHours: val });

            return (
                <div className={`bg-white rounded-2xl shadow-sm overflow-hidden transition-all duration-200 hover:shadow-md sm:flex-1 relative ${isToday ? 'ring-2 ring-blue-500/20' : ''}`}>
                    {/* Approved accent â€” inner bar that doesn't break radius */}
                    {approved && (
                        <div className="absolute top-0 left-0 w-1 h-full bg-green-400 rounded-l-2xl sm:w-full sm:h-1 sm:rounded-t-2xl sm:rounded-l-none" />
                    )}

                    {/* Header */}
                    <div className="flex items-center justify-between px-4 py-3 sm:flex-col sm:items-center sm:gap-0.5 sm:pt-4 sm:pb-3">
                        <div className="flex items-center gap-2 sm:flex-col sm:items-center">
                            <div className="flex items-center gap-2">
                                <span className={`w-2 h-2 rounded-full flex-shrink-0 transition-colors duration-300 ${approved ? 'bg-green-400' : 'bg-gray-200'}`} />
                                <span className="font-semibold text-gray-900">{DAY_LABELS[day]}</span>
                            </div>
                            <span className="text-xs text-gray-400">{getDayDate(mondayDate, dayIndex)}</span>
                        </div>
                        <span className={`text-sm font-semibold tabular-nums transition-colors duration-300 ${approved ? 'text-green-500' : 'text-gray-300'}`}>
                            {fmt(totalDay)}/{HOURS_PER_DAY}u
                        </span>
                    </div>

                    {/* Inputs */}
                    <div className="grid grid-cols-2 gap-3 px-4 pb-4 sm:grid-cols-1">
                        <div>
                            <label className="text-[11px] font-medium text-gray-400 uppercase tracking-wider block mb-1.5">Werk</label>
                            <HoursInput value={workHours} onChange={setWork} max={24} />
                        </div>
                        <div>
                            <label className="text-[11px] font-medium text-gray-400 uppercase tracking-wider block mb-1.5">Vrij</label>
                            <HoursInput value={freeHours} onChange={setFree} max={8} />
                        </div>
                    </div>

                    {/* Day progress */}
                    <div className="h-1 bg-gray-100">
                        <div
                            className={`h-full transition-all duration-500 ${approved ? 'bg-green-400' : dayPct > 0 ? 'bg-blue-400' : ''}`}
                            style={{ width: `${dayPct}%` }}
                        />
                    </div>
                </div>
            );
        }

        // --- Segmented Control ---
        function SegmentedControl({ onPrev, onToday, onNext, isCurrent }) {
            return (
                <div className="inline-flex bg-gray-200/60 rounded-xl p-1 gap-0.5">
                    <button onClick={onPrev}
                        className="w-11 h-11 flex items-center justify-center text-sm font-medium text-gray-500 rounded-lg active:scale-95 active:bg-white/60 transition-all hover:text-gray-900">
                        &larr;
                    </button>
                    <button onClick={onToday}
                        className={`px-5 h-11 text-sm font-medium rounded-lg active:scale-95 transition-all ${isCurrent ? 'text-gray-900 bg-white shadow-sm' : 'text-gray-500 hover:text-gray-900'}`}>
                        Vandaag
                    </button>
                    <button onClick={onNext}
                        className="w-11 h-11 flex items-center justify-center text-sm font-medium text-gray-500 rounded-lg active:scale-95 active:bg-white/60 transition-all hover:text-gray-900">
                        &rarr;
                    </button>
                </div>
            );
        }

        // --- App ---
        function App() {
            const [currentMonday, setCurrentMonday] = useState(() => getMonday(new Date()));
            const [allData, setAllData] = useState(() => loadAllData());
            const [toastVisible, setToastVisible] = useState(false);

            const weekKey = formatDate(currentMonday);
            const weekData = allData[weekKey] || createEmptyWeek();
            const isCurrent = isCurrentWeek(currentMonday);

            // Determine today's day index (0=mon, 4=fri, -1=weekend)
            const todayDate = new Date();
            const todayDayOfWeek = todayDate.getDay();
            const todayIndex = isCurrent && todayDayOfWeek >= 1 && todayDayOfWeek <= 5 ? todayDayOfWeek - 1 : -1;

            useEffect(() => {
                const shared = decodeWeekFromURL();
                if (shared && shared.week && shared.days) {
                    setAllData(prev => ({ ...prev, [shared.week]: shared.days }));
                    setCurrentMonday(new Date(shared.week));
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }, []);

            useEffect(() => { saveAllData(allData); }, [allData]);

            const shareWeek = () => {
                navigator.clipboard.writeText(encodeWeekToURL(weekKey, weekData)).then(() => {
                    setToastVisible(true);
                    setTimeout(() => setToastVisible(false), 1800);
                });
            };

            const handleDayChange = useCallback((day, newDayData) => {
                setAllData(prev => ({
                    ...prev,
                    [weekKey]: { ...(prev[weekKey] || createEmptyWeek()), [day]: newDayData }
                }));
            }, [weekKey]);

            const goWeek = (offset) => {
                const next = new Date(currentMonday);
                next.setDate(next.getDate() + offset * 7);
                setCurrentMonday(next);
            };

            const goToday = () => setCurrentMonday(getMonday(new Date()));

            const weekEnd = new Date(currentMonday);
            weekEnd.setDate(weekEnd.getDate() + 4);
            const weekLabel = `${currentMonday.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long' })} \u2014 ${weekEnd.toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' })}`;

            return (
                <div className="max-w-xl mx-auto px-4 py-6 pb-12 sm:max-w-7xl sm:py-8">
                    <Toast message="Link gekopieerd" visible={toastVisible} />

                    {/* Header */}
                    <div className="flex items-center justify-between mb-1">
                        <h1 className="text-2xl font-bold text-gray-900 tracking-tight">Weekplanner</h1>
                        <button onClick={shareWeek}
                            className="w-11 h-11 flex items-center justify-center rounded-full hover:bg-gray-200/60 active:scale-90 transition-all"
                            title="Deel week">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" /><polyline points="16 6 12 2 8 6" /><line x1="12" y1="2" x2="12" y2="15" />
                            </svg>
                        </button>
                    </div>

                    <p className="text-sm text-gray-400 mb-4">{weekLabel}</p>

                    {/* Navigation */}
                    <div className="flex justify-center mb-6">
                        <SegmentedControl
                            onPrev={() => goWeek(-1)}
                            onToday={goToday}
                            onNext={() => goWeek(1)}
                            isCurrent={isCurrent}
                        />
                    </div>

                    {/* Week summary */}
                    <div className="mb-6">
                        <WeekSummary days={weekData} />
                    </div>

                    {/* Day cards */}
                    <div className="flex flex-col gap-3 sm:flex-row sm:gap-3">
                        {DAYS.map((day, i) => (
                            <DayCard
                                key={day}
                                day={day}
                                dayIndex={i}
                                mondayDate={currentMonday}
                                data={weekData[day] || { workHours: 0, freeHours: 0 }}
                                onChange={handleDayChange}
                                isToday={i === todayIndex}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
